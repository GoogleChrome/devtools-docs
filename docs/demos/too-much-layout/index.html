{{+bindTo:partials.standard_devtools_article canonical:strings.canonicalDevToolsForcedSynchronousLayoutDemo}}
<h1>Timeline demo: Diagnosing forced synchronous layouts</h1>

    <p>This demo shows how you can use the Timeline to identify a kind of performance bottle-neck called 'forced synchronous layouts'. The demo application animates several images back and forth using <code><a href="http://docs.webplatform.org/wiki/apis/timing/methods/requestAnimationFrame" _target="_blank">requestAnimationFrame()</a></code>, the <a href="http://updates.html5rocks.com/2012/05/requestAnimationFrame-API-now-with-sub-millisecond-precision" target="_blank">recommended approach</a> for performing frame-based animation. But there's a considerable amount of stuttering and jank as the animation runs We'll use the Timeline to diagnose what's going on.</p>

   <p>For more information about using Frames mode and forced asynchronous layouts see <a href="../using-timeline.html#locating_forced_synchronous_layouts">Locating forced synchronous layouts</a> in <a href="../using-timeline">Using the Timeline</a>.</p>

<div class="collapsible">
    <h2>
        Make a recording
    </h2>

    <p>
        First you'll make a recording of the animation.</p>
    <ol>
        <li>Click <strong>Start</strong> to start the animation.</li>
        <li>Open the Timeline panel on this page, and go the Frames view.</li>
        <li>Click the Record button in the Timeline.</li>
        <li>After after a second or two (10-12 frames recorded) stop the recording and click <strong>Stop</strong> to stop the animation.</li>
    </ol>

<!--     <section class="expandable">
         <button type="button" class="button-red button expand-control" id="show-hide-1">Show/Hide Demo</button>
 -->

        <button id="toggle">Start</button>

        <div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
                <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
                <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
                <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
                <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
                <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>

        </div>

        <script src="source.js"></script>        

</div>
<div class="collapsible">
    <h2>Analyze the recording</h2>

    <p>
        Looking at the recording of the first few frames it's clear that each one is taking over 300ms to complete. If you hover your mouse over one of the frames a pop-up appears showing additional details about the frame.</p>

       <div class="screenshot"> <img src="images/frame-rate.png" alt=""></div>
    <p>
        Locate an Animation Frame Fired record and notice the yellow warning icon next to it, indicating a forced synchronous layout. The icon is slightly dimmed indicating that one of its child records contains the offending code, rather than this record itself. Expand the Animation Frame Fired to view its children.
    </p>

    <div class="screenshot"><img src="images/recording-1.png"></div>

    <p>
        The child records show a long, repeating pattern of <strong>Recalculate Style</strong> and <strong>Layout</strong> records. Each layout record is a result of the style recalculation that, in turn, is a result of the <code>requestAnimationFrame()</code> handler requesting the value of <code>offsetTop</code> for each image on the page. Hover your mouse over one of the Layout records and click the link for sources.js next to the Layout Forced property.
    
    <div class="screenshot"><img src="images/layout-warning-hover.png"></div>
    
    <p>
        The Sources panel opens at line 43 of the source file at the <code>update()</code> function, which is the <code>requestAnimationCallback()</code> callback handler. The handler computes the image's <code>left</code> CSS style proeprty on the the image's <code>offsetTop</code> value. This forces Chrome to perform a new layout immediately to make sure it provides the correct value.
    </p>

    <pre class="prettyprint lang-js">
// Animation loop
function update(timestamp) {
    for(var m = 0; m < movers.length; m++) {
        movers[m].style.left = ((Math.sin(movers[m].offsetTop + timestamp/1000)+1) * 500) + 'px';
        }
    raf = window.requestAnimationFrame(update);
};
</pre>

<p>We know that forcing a page layout during every animation frame is slowing things down. Now we can try to fix the problem directly in DevTools.</p>

</div>
<div class="collapsible">
    <h2>Apply fix within DevTools</h2>

    <p>Now that we have an idea what's causing the performance issues, we can modify the JavaScript file directly in the Sources panel and test our changes right away.</p>
    
    <ol>
        <li>In the Sources panel that was opened previously, replace line 43 with the following code.</li>
            <code style="prettyprint" lang-js><pre>movers[m].style.left = ((Math.sin(m + timestamp/1000)+1) * 500) + 'px';</pre></code>
            <p>This version computes each image's <code>left</code> style property on its index in its holding array instead of on a layout-dependent property (<code>offsetWidth</code>).</p>

        <li>Save your changes by pressing Cmd-S or Ctrl-S.</li>
    </ol>

</div>
<div class="collapsible">
<h2>Verify with another recording</h2>

        <p>The animation is clearly faster and smoother than before, but it's always good practice to measure the difference with another recording. It should look something like the recording below.</p>

        <div class="screenshot"><img src="images/fixed.png"></div>

</div>
{{/partials.standard_devtools_article}}
